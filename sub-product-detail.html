<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Pretendard Font -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.8/dist/web/static/pretendard.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="./assets/css/common.css" />
    <link rel="stylesheet" href="./assets/css/sub-product-detail.css" />
    <title>인바이러스테크</title>
</head>

<body>
    <header class="site-header">
        <a href="/" class="mobile-logo"><img src="./assets/img/logo.png" alt="InVirusTech Logo" /></a>
        <button class="hamburger" aria-controls="sidebar" aria-expanded="false" aria-label="Open menu">
            <i class="fa-solid fa-bars"></i>
        </button>
    </header>

    <nav class="sidebar">
        <a href="/" class="logo"><img src="./assets/img/logo.png" alt="InVirusTech Logo" /></a>
        <a class="menu-item" data-cat="all">ALL</a>
        <a class="menu-item" data-cat="life-science">Life Science</a>
        <a class="menu-item" data-cat="molecular-diagnostic">Molecular diagnostic</a>
        <a class="menu-item" data-cat="plastic-ware">Plastic ware</a>
        <a class="menu-item" data-cat="others">Others</a>
        <a href="sub-company.html" class="menu-item">Company</a>
        <a href="sub-inquiry.html" class="menu-item">Inquiry</a>
        <div class="footer">www.invirustech.com</div>
    </nav>

    <div class="content">
        <div class="sub-header">
            <img class="product-visual" src="./assets/img/sub-product-detail-bg01.png" alt="Product Image" />
            <h1 class="title">Product</h1>

            <div class="header-quote">
                <span class="quote">Innovate molecular diagnostics.<br>Steer clear of false-negative and -positive
                    errors.</span><br>
                <span class="corp">InVirusTech Inc.</span>
            </div>
        </div>

        <section class="product-detail">
            <div class="product-info">
                <div class="product-texts">
                    <div class="product-category"></div>
                    <h2 class="product-name"></h2>
                </div>
                <div class="image-wrapper">
                    <img class="product-image" src="" alt="product image" />
                </div>
            </div>
        </section>

        <section class="product-overview">
            <h3 class="section-title">Product overview</h3>
            <p class="text overview"></p>

            <h3 class="section-title">Features</h3>
            <ul class="features-list"></ul>

            <h3 class="section-title">Applications</h3>
            <ul class="applications-list"></ul>

            <h3 class="section-title">Protocol</h3>
            <p class="text protocol"></p>

            <h3 class="section-title">Experimental Data</h3>

            <h3 class="section-title">Ordering Information</h3>
            <div class="ordering-image"><img src="" /></div>
        </section>
    </div>

    <footer class="main-footer">
        <div class="footer-left">
            <p>Address. (61011) 607, 17-11, Cheomdangwagi-ro 208beon-gil, Buk-gu, Gwangju, Republic of Korea</p>
            <p>Email. invirustech@invirustech.com</p>
            <div class="contacts">
                <div><strong>Tel</strong> <span>+82 062-511-0682</span></div>
                <div><strong>Fax</strong> <span>+82 062-531-0682</span></div>
            </div>
        </div>
        <div class="footer-right">
            <img src="./assets/img/footer-logo.png" alt="InVirusTech Logo" />
            <p>© 2025 InVirusTech Inc. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- jQuery v3.7.1 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="./assets/js/common.js"></script>

    <script>
        const DATA_BASE = './data/';
        const CATEGORY_FILES = {
            'life-science': 'life-science.json',
            'molecular-diagnostic': 'molecular-diagnostic.json',
            'plastic-ware': 'plastic-ware.json',
            'others': 'others.json'
        };

        const cache = new Map();
        async function loadJSON(p) {
            if (cache.has(p)) return cache.get(p);
            const pr = fetch(p, { cache: 'no-store' }).then(async (r) => {
                if (!r.ok) throw new Error(`HTTP ${r.status} @ ${r.url}`);
                return r.json();
            });
            cache.set(p, pr);
            return pr;
        }

        async function getProductBySlug(slug) {
            const manifest = await loadJSON(DATA_BASE + 'manifest.json');
            const cat = manifest.index?.[slug];
            if (!cat) return null;
            const data = await loadJSON(DATA_BASE + CATEGORY_FILES[cat]);
            return (data.products || []).find(p => p.slug === slug) || null;
        }

        async function resolveCategoryFromManifest(slug) {
            const manifest = await loadJSON(DATA_BASE + 'manifest.json');
            return manifest.index?.[slug] || null;
        }

        $(async function () {
            const params = new URLSearchParams(location.search);
            const pid = params.get('pid') || (location.hash || '').slice(1);
            if (!pid) {
                $('.product-overview').prepend('<p class="text">Missing product ID.</p>');
                return;
            }

            try {
                const p = await getProductBySlug(pid);
                if (!p) {
                    $('.product-overview').prepend(`<p class="text">Product not found. (ID: ${pid})</p>`);
                    return;
                }

                const catKey = await resolveCategoryFromManifest(pid);
                const titleMap = {
                    'life-science': 'Life Science',
                    'molecular-diagnostic': 'Molecular Diagnostic',
                    'plastic-ware': 'Plastic Ware',
                    'others': 'Others'
                };

                const listPageHref = 'sub-product.html';

                $('.sidebar .menu-item[data-cat]').each(function () {
                    const key = String($(this).data('cat') || '').toLowerCase();

                    $(this).attr('href', `${listPageHref}?cat=${encodeURIComponent(key)}`);

                    const isActive = key === String(catKey || '').toLowerCase();
                    $(this).toggleClass('on', isActive);
                    if (isActive) $(this).attr('aria-current', 'page');
                    else $(this).removeAttr('aria-current');
                });

                // header
                const catDisplay = titleMap[catKey] || '';
                const subLabel = p.categoryLabel || '';
                const catLine = [catDisplay, subLabel]
                    .filter(Boolean)
                    .join(' - ')
                    .replace(/<\s*br\s*\/?\s*>/gi, ' ');
                $('.product-category').text(catLine);

                const detailName = p.name.replace('<br>', ' ');
                $('.product-name').html(detailName);
                $('.product-image')
                    .attr('src', p.image || p.thumbnail || '')
                    .attr('alt', String(p.name || '').replace(/<[^>]*>/g, ''));

                // overview / protocol
                const setText = (sel, val) => {
                    const has = val && String(val).trim() !== '';
                    if (has) {
                        $(sel)
                            .html(String(val).replace(/(?:\r\n|\r|\n)/g, '<br>').replace(/<br\s*\/?>/gi, '<br>'))
                            .removeAttr('hidden');
                        $(sel).prev('.section-title').removeAttr('hidden');
                    } else {
                        $(sel).attr('hidden', true).prev('.section-title').attr('hidden', true);
                    }
                };
                setText('.overview', p.overview);
                setText('.protocol', p.protocol);

                // features / applications
                const setList = (sel, arr) => {
                    if (Array.isArray(arr) && arr.length) {
                        $(sel).html(arr.map(x => `<li>${x}</li>`).join(''));
                    } else {
                        $(sel).attr('hidden', true).prev('.section-title').attr('hidden', true);
                    }
                };
                setList('.features-list', p.features);
                setList('.applications-list', p.applications);

                // experimental data
                $('.text.experimental').remove();
                const $expTitle = $('.section-title')
                    .filter((_, el) => $(el).text().includes('Experimental Data'))
                    .eq(0);

                if (p.experimentalData?.length) {
                    let $last = $expTitle;
                    p.experimentalData.forEach(t => {
                        const $el = $(`<p class="text experimental">${t}</p>`);
                        $last.after($el);
                        $last = $el;
                    });
                } else {
                    $expTitle.attr('hidden', true);
                }

                // ordering image
                const getOrderingItems = (p) => {
                    if (Array.isArray(p.orderingImage)) return p.orderingImage;
                    if (Array.isArray(p.orderingImages)) return p.orderingImages;
                    if (Array.isArray(p.ordering)) return p.ordering;
                    return p.orderingImage ? [p.orderingImage] : [];
                };

                const items = getOrderingItems(p);
                const $wrap = $('.ordering-image');

                if (items.length) {
                    $wrap.empty();
                    const altBase = $('.product-name').text().trim();

                    items.forEach((it, i) => {
                        const src = typeof it === 'string' ? it : it.src;
                        const note = typeof it === 'string' ? '' : (it.note || it.caption || '');

                        const $block = $('<div class="ordering-block"></div>');

                        if (note) {
                            $('<p class="ordering-caption"></p>')
                                .html(note) 
                                .appendTo($block);
                        }

                        $('<img>', {
                            src,
                            loading: 'lazy',
                            alt: `${altBase} ordering information${items.length > 1 ? ` (${i + 1})` : ''}`
                        }).appendTo($block);

                        $wrap.append($block);
                    });

                    $wrap.removeAttr('hidden').prev('.section-title').removeAttr('hidden');
                } else {
                    $wrap.attr('hidden', true).prev('.section-title').attr('hidden', true);
                }
            } catch (e) {
                console.error('[DETAIL] load failed:', e);
                $('.product-overview').prepend('<p class="text">Failed to load product detail.</p>');
            }
        });
    </script>

</body>

</html>